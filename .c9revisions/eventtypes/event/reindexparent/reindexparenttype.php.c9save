{"ts":1363854669926,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"<?php\n//\n// ChildrenIndexer - extension for eZ Publish\n// Copyright (C) 2008 Seeds Consulting AS, http://www.seeds.no/\n//\n// This program is free software; you can redistribute it and/or\n// modify it under the terms of version 2.0 of the GNU General\n// Public License as published by the Free Software Foundation.\n//\n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with this program; if not, write to the Free Software\n// Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,\n// MA 02110-1301, USA.\n//\n\nclass ReindexParentType extends eZWorkflowEventType\n{\n    const WORKFLOW_TYPE_ID = 'reindexparent';\n\n    function __construct()\n    {\n        parent::__construct( ReindexParentType::WORKFLOW_TYPE_ID, 'Reindex parent node' );\n    }\n\n    function execute( $process, $event )\n    {\n        $parameters = $process->attribute( 'parameter_list' );\n       \n        if(isset($parameters['object_id']))\n        {\n        \t$sqlFilter = \"WHERE contentobject_id=\".$parameters['object_id'];\n        }\n        elseif (isset($parameters['node_list']) && is_array( $parameters['node_list'] ) ) \n        {\n        \t$sqlFilter = \"WHERE node_id IN (\".implode(',', $parameters['node_list'] ).\")\";\n        }\n        \n        $objectID = $parameters['object_id'];\n\n        $db = eZDB::instance();\n\n        $pathString = $db->arrayQuery( \"SELECT path_string FROM ezcontentobject_tree $sqlFilter\" );\n        \n        if ( $pathString )\n        {\n        \t$pathString2 =array();\n        \tforeach ($pathString as $elt)\n        \t{\n        \t\t$pathString2 = array_merge($pathString2, explode( '/', trim( $elt['path_string'], '/' ) ) );\n        \t}\n        \t$pathString2 = array_unique($pathString2);\n        \trsort($pathString2);\n            $path = array_reverse( $pathString2 );\n            array_shift( $path );\n            // $path now contains node IDs of all ancestors (starting with the parent node)\n            foreach( $path as $ancestorNodeID )\n            {\n                /* Find object ID but only if the ancestor's object contains searchable\n                   attribute of the childrenindexer datatype. */\n                $ancestorObjectID = $db->arrayQuery( \"SELECT a.contentobject_id\n                                                      FROM ezcontentobject_tree t,\n                                                           ezcontentobject_attribute a,\n                                                           ezcontentclass_attribute ca\n                                                      WHERE t.node_id=$ancestorNodeID\n                                                        AND t.contentobject_id=a.contentobject_id\n                                                        AND t.contentobject_version=a.version\n                                                        AND a.contentclassattribute_id=ca.id\n                                                        AND ca.version=0\n                                                        AND ca.data_type_string='childrenindexer'\n                                                        AND ca.is_searchable=1\", array( 'limit' => 1 ) );\n                if ( !$ancestorObjectID )\n                {\n                    continue;\n                }\n                \n                $ancestorObjectID = $ancestorObjectID[0]['contentobject_id'];\n                eZContentOperationCollection::registerSearchObject( $ancestorObjectID, false );\n            }\n        }\n\n        return eZWorkflowType::STATUS_ACCEPTED;\n    }\n}\n\neZWorkflowEventType::registerEventType( ReindexParentType::WORKFLOW_TYPE_ID, 'reindexparenttype' );\n\n?>\n"]],"start1":0,"start2":0,"length1":0,"length2":3849}]],"length":3849}
